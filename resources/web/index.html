<html>
<head>
<script src="cytoscape.min.js"></script>
<script src="jquery-3.3.1.min.js"></script>
<style rel='stylesheet' type='text/css'>
div#page { 	
    width: 1000px;
    height: 800px;
}
div#header {  	
    width: 1000px;
    height: 130px;
    background: #FFFFFF;
    
}

div#container {
    clear: both;
}

div#cy { 	
  	float: left;   	
  	height: 620px;   	
  	overflow: hidden;   	  	
  	width: 700px;
  	background: #F0F0F0;
}
div#legenda {
    float: left;   	
  	height: 620px;   	
  	overflow: hidden;   	  	
  	width: 300px;
  	background: #E0E0E0;
}
div#footer {
	clear: both;
    float: left;   	
  	height: 50px;   	
  	overflow: hidden;   	  	
  	width: 1000px;
  	background: #FFFFFF;
}

      
</style>
</head>

<body>
<div id="page">
	<div id="header">
		<h1>YummyData Playground</h1>
		<form id="searchForm" name="searchForm">
			<input size="120" type="text" id="entities" name="entities" placeholder="List a set of things you know or are interested in" disabled /><br/>
			<i>only a view on the server script now!</i>
			<button type="button" disabled>Go!</button> 
			<button type="button" id="refresh" onclick="parseGraph()">Load</button> 
			<button type="button" id="auto" onclick="setAutoGraph()">Auto</button>  
			<button type="button" id="stop" onclick="stopAutoGraph()">Stop</button>
		</form>
	</div>
	<div id="container">
		<div id="cy"></div>
		<div id='legenda'></div>
	</div>
	<div id="footer"> &copy; 2018 BH</a>
</div>




<script type='text/javascript'>

function class2Shape(cl) {
	
	if(cl==='class') {
		return('ellipse');
	}
	else if(cl==='instance') {
		return('round-rectangle');
	}
	else if(cl==='plain') {
		return('star');
	}
	else return('star');	
}

function nodeSize(size) {
	if(size==0) {
		return 10;
	}
	else {
		alert(size+" -> "+Math.sqrt(size))
		return Math.sqrt(size);
	}
}

cy = cytoscape({
  container: document.getElementById('cy'), // container to render in

  style: cytoscape.stylesheet()
 	.selector('node')
      .style({
        'background-color': '#666',
        'label': 'data(name)',
        'shape': function( ele ){  return class2Shape(ele.data('type'));},
        'background-color' : function(ele) { return endpointsCMap[ele.data('endpoint')];},
        'width': function(ele) {return nodeSize(ele.data('size'));},
        'height': function(ele) {return nodeSize(ele.data('size'));}
      }
    )
	.selector('edge')
      .style({
        'width': 3,
        'line-color': '#ccc',
        'target-arrow-color': '#ccc',
        'target-arrow-shape': 'triangle'
      })
    
  

  

});

// from: https://stackoverflow.com/questions/1484506/random-color-generator
function getRandomColor() {
  var letters = '0123456789ABCDEF';
  var color = '#';
  for (var i = 0; i < 6; i++) {
    color += letters[Math.floor(Math.random() * 16)];
  }
  return color;
}

var endpointsCMap={};
	
//document.write("Graph rendering function called");

</script>

<!-- script type='text/javascript'>

var cc=1;
var lastId='a'
function myTimer() {
	cc=cc+1;
	var nId='n'+cc;
	
    cy.add({
    group: 'nodes',
    data: { id: nId }
	});
	cy.add({ group: 'edges', data: { id: 'e'+cc, source: lastId, target: nId } });
	lastId=nId;
	var layout = cy.layout({
  		name: 'cose'
	});

	layout.run();
}

var myVar = setInterval(myTimer, 1000);


</script -->
<script type='text/javascript'>

function updateEndpoint(ep) {
	if(!endpointsCMap.hasOwnProperty(ep)) {
		endpointsCMap[ep]=getRandomColor();
		document.getElementById('legenda').innerHTML += '<font color='+endpointsCMap[ep]+'>'+ep+'</font></br>';
	
	}
}

function processPlain(ep,elements) {
	nodeId=elements[2];	
	nodeName=elements[3];	
	//alert('Adding plain node '+nodeId+' ('+ep+')') //test
	node=cy.getElementById(nodeId);
	if(node.length=='') {
		cy.add({
    		group: 'nodes',
    		data: { endpoint: ep , id: nodeId, type: 'instance', name: nodeName}
	  	})
	}	
}

function processClass(ep,elements) {
	nodeId=elements[2];
	nodeName=elements[3];	
	console.log('Process class: '+nodeId)
	node=cy.getElementById(nodeId);
	if(node.length=='') {
		//alert('Adding class node '+nodeId+' ('+ep+')') // test
		cy.add({
    		group: 'nodes',
    		data: { endpoint: ep , id: nodeId, type: 'class', name: nodeName}
	  	})
	}
	else {
		//alert('Changing type to class for node '+nodeId+' ('+ep+')') //test
		node[0].data({type:'class'});
	}
}

function setAttribute(ep,elements) {
	nodeId=elements[2];
	attribute=elements[2];	
	value=elements[3];
	console.log('Process attr for: '+nodeId)
	node=cy.getElementById(nodeId);
	if(node.length>0) {
		node[0].data({attribute:value});
	}
}


function processInstance(ep,elements) {
//http://dbpedia.org/sparql	inst	node5	node2	name_node2
	//alert('Instance');
	nodeId=elements[2];
	classId=elements[3];
	nodeName=elements[4];
	
	node=cy.getElementById(nodeId);
	if(node.length==0) {
		//alert('Adding instance node '+nodeId+' ('+ep+')') // test
		cy.add({
    		group: 'nodes',
    		data: { endpoint: ep , id: nodeId, type: 'instance', name: nodeName}
	  	})
	}
	else {
		//alert('Changing type to class for node '+nodeId+' ('+ep+')') //test
		node[0].data({type:'instance'});
	}
	//Same for class
	nodeC=cy.getElementById(classId);
	if(nodeC.length==0) {
		//alert('Adding class node '+classId+' ('+ep+')') // test
		cy.add({
    		group: 'nodes',
    		data: { endpoint: ep , id: classId, type: 'class', name: classId}
	  	})
	}
	else {
		//alert('Changing type to class for node '+classId+' ('+ep+')') //test
		nodeC[0].data({type:'class'});
	}
	//Same for link
	rel=cy.edges('edge[source = \"'+nodeId+'\"][target = \"'+classId+'\"][type=\"instanceOf\"]');
	if(rel.length==0) {
		console.log('edge found');
		cy.add({
    		group: 'edges',
    		data: { id: nodeId+'_instOf_'+classId, endpoint: ep , source: nodeId, target: classId, type: 'instanceOf', name: 'instanceOf'}
	  	})
	}
	else {
		console.log('edge not found');	
	}
}


parseGraph = function (){
	cy.startBatch();
  	$.ajaxSetup({ cache: false });	
  	$.ajax({
    	//url:'demodata.txt?' + new Date().getTime(),
    	url:'outCy.txt?' + new Date().getTime(),
    	success: function (data){
      		var commands=data.split('\n'); 
      		var cl;
	  		for (cl = 0; cl < commands.length; cl++) { 
	  			elements=commands[cl].split('\t');
	  			ep=elements[0];
	  			updateEndpoint(ep);
	  			command=elements[1];
	  	
	  			if(command=='plain') { processPlain(ep,elements); }
	 			if(command=='class') { processClass(ep,elements); } 
	 			if(command=='inst') {processInstance(ep,elements);}
	 			if(command=='set') {setAttribute(ep,elements);}
	 		
	
	  		}   
    	}
    	
  	});
	console.log("endAdding");
	cy.endBatch();
	console.log("endBatch");
 	var layout = cy.layout({
  		name: 'cose'
   	});
   	layout.run();
   	console.log("endLayout");
}
//parseGraph()

var myVar;
function setAutoGraph() {
	myVar = setInterval(parseGraph, 30000);
}
function stopAutoGraph() {
	clearInterval(myVar);
}
 

</script>
</script>
</body>
</html>


  



  

